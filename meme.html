<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YANZZ - Memes</title>
  <link rel="manifest" href="manifest.json" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-dark: #121212;
      --card-bg-dark: #1e1e1e;
      --accent: #d4af37;
      --text-dark: #f5f5f5;
      --sub-dark: #bbbbbb;

      --bg-light: #f5f5f5;
      --card-bg-light: #fff;
      --text-light: #222;
      --sub-light: #555;

      --radius: 12px;
      --trans: 0.3s;
    }
    body[data-theme="dark"] {
      background: var(--bg-dark);
      color: var(--text-dark);
    }
    body[data-theme="dark"] header,
    body[data-theme="dark"] .card,
    body[data-theme="dark"] select,
    body[data-theme="dark"] button {
      background: var(--card-bg-dark);
      color: var(--text-dark);
      border-color: var(--sub-dark);
    }
    body[data-theme="dark"] nav button {
      border-color: var(--sub-dark);
      color: var(--sub-dark);
      background: transparent;
    }
    body[data-theme="dark"] nav button.active,
    body[data-theme="dark"] nav button:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg-dark);
    }
    body[data-theme="dark"] .actions button {
      border-color: var(--accent);
      color: var(--accent);
    }
    body[data-theme="dark"] .actions button:hover {
      background: var(--accent);
      color: var(--bg-dark);
    }

    body[data-theme="light"] {
      background: var(--bg-light);
      color: var(--text-light);
    }
    body[data-theme="light"] header,
    body[data-theme="light"] .card,
    body[data-theme="light"] select,
    body[data-theme="light"] button {
      background: var(--card-bg-light);
      color: var(--text-light);
      border-color: var(--sub-light);
    }
    body[data-theme="light"] nav button {
      border-color: var(--sub-light);
      color: var(--sub-light);
      background: transparent;
    }
    body[data-theme="light"] nav button.active,
    body[data-theme="light"] nav button:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg-light);
    }
    body[data-theme="light"] .actions button {
      border-color: var(--accent);
      color: var(--accent);
    }
    body[data-theme="light"] .actions button:hover {
      background: var(--accent);
      color: var(--bg-light);
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      font-family: 'Poppins', sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      margin: 0;
      transition: background-color var(--trans), color var(--trans);
    }
    header {
      position: sticky;
      top: 0;
      z-index: 100;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
      transition: background-color var(--trans), color var(--trans);
    }
    header h1 {
      font-weight: 600;
      font-size: 1.8rem;
      user-select: none;
      color: var(--accent);
      letter-spacing: 1px;
      text-shadow: 0 0 8px var(--accent);
    }
    nav {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    nav button#themeToggleBtn {
      font-size: 1.5rem;
      padding: 0.25rem 0.5rem;
      border: none;
      background: transparent;
      cursor: pointer;
      user-select: none;
      transition: transform 0.3s ease;
      line-height: 1;
    }
    nav button#themeToggleBtn:hover {
      transform: scale(1.2);
    }
    main {
      flex: 1;
      max-width: 960px;
      margin: 2rem auto;
      padding: 0 1rem;
      width: 100%;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 2rem;
      align-items: center;
    }
    select {
      padding: 0.6rem 1rem;
      border-radius: var(--radius);
      border: 1.5px solid;
      font-size: 1rem;
      outline-offset: 2px;
      outline-color: var(--accent);
      min-width: 180px;
      transition: border-color var(--trans), background-color var(--trans), color var(--trans);
      user-select: text;
      background: inherit;
      color: inherit;
    }
    .controls button {
      background: var(--accent);
      border: none;
      color: var(--bg-dark);
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: var(--radius);
      cursor: pointer;
      user-select: none;
      transition: background-color var(--trans), opacity var(--trans);
    }
    .controls button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .feed {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.8rem;
    }
    .card {
      background: var(--card-bg-dark);
      border-radius: var(--radius);
      box-shadow: 0 4px 15px rgba(0,0,0,0.7);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: transform var(--trans);
      cursor: default;
    }
    body[data-theme="light"] .card {
      background: var(--card-bg-light);
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    .card:hover {
      transform: translateY(-8px) scale(1.03);
      box-shadow: 0 10px 30px rgba(0,0,0,0.9);
    }
    .card img, .card video {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
      background: #000;
      cursor: pointer;
      border-radius: var(--radius) var(--radius) 0 0;
      user-select: none;
    }
    .actions {
      padding: 0.75rem 1rem;
      border-top: 1px solid rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      transition: border-color var(--trans);
    }
    body[data-theme="light"] .actions {
      border-top-color: rgba(0,0,0,0.1);
    }
    .actions button {
      border: 1.5px solid var(--accent);
      background: transparent;
      color: var(--accent);
      border-radius: var(--radius);
      padding: 0.45rem 1rem;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      user-select: none;
      transition: background-color var(--trans), color var(--trans);
    }
    .actions button:hover {
      background: var(--accent);
      color: var(--bg-dark);
    }
    .loader {
      text-align: center;
      color: var(--sub-dark);
      font-size: 1.2rem;
      margin-top: 2rem;
      user-select: none;
    }
    .lightbox {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      cursor: zoom-out;
      user-select: none;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .lightbox.show {
      opacity: 1;
      pointer-events: auto;
    }
    .lightbox img,
    .lightbox video {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: var(--radius);
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
      user-select: none;
    }
  </style>
</head>
<body data-theme="dark">
  <header>
    <h1>YANZZ - Memes</h1>
    <nav>
      <button id="themeToggleBtn" aria-label="Toggle dark/light theme" title="Toggle Theme" onclick="toggleTheme()">🌙</button>
    </nav>
  </header>
  <main>
    <div class="controls" role="region" aria-label="Meme controls">
      <select id="categorySelect" onchange="resetFeed()" aria-label="Select meme category">
        <option value="">All Categories</option>
        <option value="funny">Funny</option>
        <option value="wholesome">Wholesome</option>
        <option value="gaming">Gaming</option>
        <option value="animal">Animal</option>
        <option value="meme">Meme</option>
        <option value="dank">Dank</option>
      </select>
      <button id="loadSingleBtn" onclick="loadCurrent()" aria-label="Load one meme">Load 1 Meme</button>
      <button id="loadMultiBtn" onclick="loadMultipleMemes(5)" aria-label="Load five memes">Load 5 Memes</button>
    </div>
    <div id="feed" class="feed" aria-live="polite" aria-atomic="true"></div>
    <div id="loader" class="loader" role="alert" aria-live="assertive"></div>
  </main>
  <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" tabindex="-1" onclick="closeLightbox()"></div>

<script>
  const apis = [
    'https://meme-api.com/gimme',
    'https://api.imgflip.com/get_memes',
    'https://meme-api.com/gimme/wholesome'
  ];
  let currentApiIndex = 0;
  const displayedMemes = new Set();

  const feed = document.getElementById('feed');
  const loader = document.getElementById('loader');
  const categorySelect = document.getElementById('categorySelect');
  const loadMultiBtn = document.getElementById('loadMultiBtn');
  const loadSingleBtn = document.getElementById('loadSingleBtn');
  const themeToggleBtn = document.getElementById('themeToggleBtn');

  async function fetchMeme() {
    loader.textContent = 'Loading meme...';
    const api = apis[currentApiIndex];
    try {
      if (api.includes('meme-api.com')) {
        const cat = categorySelect.value ? `/${categorySelect.value}` : '';
        const res = await fetch(api + cat);
        const data = await res.json();
        let url = null;
        if (data.url) url = data.url;
        else if (data.memes && data.memes.length > 0) url = data.memes[0].url;
        if (!url) throw new Error('No meme URL');

        if (displayedMemes.has(url)) {
          return fetchMeme();
        }
        return url;

      } else if (api.includes('imgflip.com')) {
        const res = await fetch(api);
        const json = await res.json();
        if (!json.success) throw new Error('Failed API');
        const memes = json.data.memes;
        const filtered = categorySelect.value
          ? memes.filter(m => m.name.toLowerCase().includes(categorySelect.value.toLowerCase()))
          : memes;
        if (filtered.length === 0) throw new Error('No memes for category');

        let meme;
        let attempts = 0;
        do {
          meme = filtered[Math.floor(Math.random() * filtered.length)];
          attempts++;
          if (attempts > 10) break;
        } while (displayedMemes.has(meme.url));

        if (displayedMemes.has(meme.url)) throw new Error('Cannot find new unique meme');
        return meme.url;
      }
      throw new Error('No valid API handler');
    } catch (e) {
      currentApiIndex = (currentApiIndex + 1) % apis.length;
      if (currentApiIndex === 0) loader.textContent = 'All APIs failed to load meme.';
      else loader.textContent = 'Failed API, switching to backup API...';
      return fetchMeme();
    } finally {
      if (currentApiIndex === 0) loader.textContent = '';
    }
  }

  function showMeme(url) {
    const card = document.createElement('div');
    card.className = 'card';
    const ext = url.split('.').pop().toLowerCase();
    const isVideo = ext === 'mp4' || ext === 'webm' || ext === 'ogg';
    const media = isVideo
      ? `<video src="${url}" autoplay muted loop controls></video>`
      : `<img src="${url}" alt="Meme Image" loading="lazy" onclick="openLightbox('${url}')" />`;
    card.innerHTML = `
      ${media}
      <div class="actions">
        <button onclick="saveMemeToMemory('${url}')">❤️ Save</button>
        <button onclick="window.open('${url}', '_blank')">🔗 View</button>
      </div>
    `;
    feed.prepend(card);
    saveMemeToMemory(url);
  }

  async function loadCurrent() {
    loadSingleBtn.disabled = true;
    try {
      const url = await fetchMeme();
      displayedMemes.add(url);
      showMeme(url);
    } catch {
      loader.textContent = 'Failed to load meme.';
    }
    loadSingleBtn.disabled = false;
  }

  async function loadMultipleMemes(count = 5) {
    loadMultiBtn.disabled = true;
    loader.textContent = `Loading ${count} memes...`;
    for (let i = 0; i < count; i++) {
      try {
        const url = await fetchMeme();
        displayedMemes.add(url);
        showMeme(url);
      } catch {
        // skip error and continue loading others
      }
    }
    loader.textContent = '';
    loadMultiBtn.disabled = false;
  }

  function openLightbox(url) {
    const lightbox = document.getElementById('lightbox');
    lightbox.innerHTML = '';
    const ext = url.split('.').pop().toLowerCase();
    if (ext === 'mp4' || ext === 'webm' || ext === 'ogg') {
      const video = document.createElement('video');
      video.src = url;
      video.controls = true;
      video.autoplay = true;
      video.style.maxWidth = '90vw';
      video.style.maxHeight = '90vh';
      lightbox.appendChild(video);
    } else {
      const img = document.createElement('img');
      img.src = url;
      img.alt = 'Meme Fullscreen';
      img.style.maxWidth = '90vw';
      img.style.maxHeight = '90vh';
      lightbox.appendChild(img);
    }
    lightbox.classList.add('show');
  }

  function closeLightbox() {
    const lightbox = document.getElementById('lightbox');
    lightbox.classList.remove('show');
    lightbox.innerHTML = '';
  }

  let userHistory = JSON.parse(localStorage.getItem('userMemeHistory') || '[]');
  function saveMemeToMemory(url) {
    if (!userHistory.includes(url)) {
      userHistory.unshift(url);
      if (userHistory.length > 50) userHistory.pop();
      localStorage.setItem('userMemeHistory', JSON.stringify(userHistory));
    }
  }

  function resetFeed() {
    feed.innerHTML = '';
    displayedMemes.clear();
    loadCurrent();
  }

  function toggleTheme() {
    const body = document.body;
    const current = body.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    body.setAttribute('data-theme', next);
    themeToggleBtn.textContent = next === 'dark' ? '🌙' : '🌞';
  }

  // เริ่มต้นตอนโหลด
  window.onload = () => {
    // ตั้งไอคอนธีมให้ถูกต้องตามโหมดเริ่มต้น
    const current = document.body.getAttribute('data-theme');
    themeToggleBtn.textContent = current === 'dark' ? '🌙' : '🌞';
    loadCurrent();
  }
</script>
</body>
  </html>
