<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YANZZ KEY</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1e1e2f, #28313b);
            color: #f0f0f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        a {
            text-decoration: none;
            color: inherit;
        }
        button {
            cursor: pointer;
            border: none;
            border-radius: 4px;
            transition: opacity 0.2s ease;
        }
        button:hover {
            opacity: 0.9;
        }
        input, select, textarea {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #555;
            background-color: #2e2e3e;
            color: #f0f0f5;
            font-size: 1rem;
        }

        /* ====== Header & Tabs ====== */
        header {
            background-color: #222;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 {
            font-size: 1.1rem;
        }
        nav#authNav button {
            margin-left: 8px;
            padding: 6px 12px;
            background-color: #444;
            color: #f0f0f5;
            font-size: 0.9rem;
        }
        /* Tab buttons */
        #tabBar {
            display: flex;
            background-color: #333;
        }
        #tabBar button {
            flex: 1;
            padding: 10px 0;
            background-color: #333;
            color: #fff;
            font-size: 1rem;
        }
        #tabBar button.active {
            background-color: #007bff;
        }

        /* ====== MainContent ====== */
        main {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }
        section {
            display: none;
        }
        section.active {
            display: block;
        }
        .section-header {
            margin-bottom: 12px;
            text-align: center;
            font-size: 1.2rem;
        }

        /* ====== Key Section ====== */
        #keySection .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 12px;
        }
        #keySection .controls > * {
            flex: 1 1 120px;
            max-width: 180px;
        }
        #keySection button {
            width: 100%;
            padding: 10px 0;
            background-color: #007bff;
            color: #fff;
            font-size: 1rem;
        }
        #keySection button#cmdSubmit {
            background-color: #28a745;
        }
        #keySection button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        #generatedKey {
            font-size: 1rem;
            padding: 10px;
            background-color: #3a3a4e;
            border: 1px dashed #555;
            border-radius: 4px;
            width: 100%;
            text-align: center;
            word-break: break-all;
            margin-bottom: 12px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* Command input */
        #cmdInput {
            flex: 1 1 100%;
            max-width: 100%;
            margin-top: 8px;
        }

        /* ====== Key List Table ====== */
        #searchContainer {
            margin: 12px 0;
            text-align: right;
        }
        #searchInput {
            width: 100%;
            max-width: 200px;
            margin-left: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            color: #f0f0f5;
        }
        th, td {
            padding: 8px;
            border: 1px solid #555;
            text-align: center;
            font-size: 0.9rem;
        }
        th {
            background-color: #444;
        }
        td.status-unused {
            color: #17a2b8;
        }
        td.status-used {
            color: #ffc107;
        }
        td.status-expired {
            color: #dc3545;
        }
        .action-btn {
            padding: 4px 6px;
            margin: 0 2px;
            font-size: 0.8rem;
            color: #f0f0f5;
            background-color: #6c757d;
        }
        .action-btn:hover {
            background-color: #5a6268;
        }

        /* ====== Verify Section ====== */
        #verifySection input {
            width: 100%;
            margin-bottom: 8px;
        }
        #verifySection button {
            width: 100%;
            background-color: #ffc107;
            color: #222;
        }
        #verifyResult {
            margin-top: 8px;
            font-size: 1rem;
            text-align: center;
        }

        /* ====== Announcement Section ====== */
        #announceInput {
            width: 100%;
            height: 80px;
            resize: vertical;
            margin-bottom: 8px;
        }
        #announceButton {
            width: 100%;
            background-color: #17a2b8;
            color: #fff;
            margin-bottom: 12px;
            padding: 10px 0;
            font-size: 1rem;
        }
        #announceList {
            max-height: 200px;
            overflow-y: auto;
            background-color: #3a3a4e;
            padding: 8px;
            border-radius: 4px;
        }
        #announceList p {
            padding: 6px;
            border-bottom: 1px solid #555;
            font-size: 0.9rem;
        }

        /* ====== Notifications ====== */
        #notifySection {
            max-height: 150px;
            overflow-y: auto;
            background-color: #3a3a4e;
            padding: 8px;
            border-radius: 4px;
            margin-top: 12px;
            font-size: 0.9rem;
        }
        #notifySection p {
            margin-bottom: 4px;
        }

        /* ====== Footer ====== */
        footer {
            text-align: center;
            padding: 10px 0;
            background-color: #222;
            color: #aaa;
            font-size: 0.8rem;
        }

        /* ====== Modal ====== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .modal-content {
            background-color: #2e2e3e;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 320px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }
        .modal-content h3 {
            margin-bottom: 12px;
            text-align: center;
            font-size: 1.1rem;
        }
        .modal-content input, .modal-content select {
            width: 100%;
            margin-bottom: 12px;
        }
        .modal-content button {
            width: 100%;
            margin-top: 8px;
        }
        .lockout-message {
            color: #dc3545;
            text-align: center;
            margin-top: 8px;
            font-size: 0.9rem;
        }

        /* ====== Responsive ====== */
        @media (max-width: 480px) {
            header h1 {
                font-size: 1rem;
            }
            #tabBar button {
                font-size: 0.9rem;
                padding: 8px 0;
            }
            #keySection .controls > * {
                flex: 1 1 100%;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>จัดการคีย์ & ประกาศ</h1>
        <nav id="authNav">
            <button id="loginButton">เข้าสู่ระบบ</button>
            <button id="logoutButton" style="display: none;">ออกจากระบบ</button>
        </nav>
    </header>

    <div id="tabBar">
        <button id="tabKey" class="active">จัดการคีย์</button>
        <button id="tabAnnounce">ประกาศอัปเดต</button>
    </div>

    <main>
        <!-- Section: จัดการคีย์ -->
        <section id="keySection" class="active">
            <div class="section-header">สร้างและจัดการคีย์</div>
            <div id="generatedKey">ยังไม่มีคีย์</div>
            <div class="controls">
                <select id="expirySelect">
                    <option value="1">หมดอายุ 1 วัน</option>
                    <option value="7" selected>หมดอายุ 7 วัน</option>
                    <option value="30">หมดอายุ 30 วัน</option>
                    <option value="90">หมดอายุ 90 วัน</option>
                </select>
                <input type="number" id="maxUsesInput" placeholder="จำนวนครั้งใช้งาน" min="1" value="1" />
                <button id="generateKeyButton">สร้างคีย์สุ่ม</button>
                <button id="cmdSubmit" style="display: none;">ส่งคำสั่ง</button>
                <input type="text" id="cmdInput" placeholder="พิมพ์คำสั่ง (owner mode)" style="display: none;" />
            </div>
            <div id="searchContainer">
                <input type="text" id="searchInput" placeholder="ค้นหาคีย์..." />
            </div>
            <table id="keyTable" style="display: none;">
                <thead>
                    <tr>
                        <th>คีย์</th>
                        <th>สถานะ</th>
                        <th>คงเหลือ</th>
                        <th>สร้างเมื่อ</th>
                        <th>หมดอายุ</th>
                        <th>จัดการ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div id="notifySection">
                <p><em>บันทึกกิจกรรมจะปรากฏที่นี่</em></p>
            </div>
        </section>

        <!-- Section: ประกาศอัปเดต -->
        <section id="announceSection">
            <div class="section-header">ประกาศอัปเดตเว็บไซต์</div>
            <textarea id="announceInput" placeholder="พิมพ์ข้อความประกาศ..."></textarea>
            <button id="announceButton" style="display: none;">ประกาศ (owner)</button>
            <div id="announceList">
                <p><em>ยังไม่มีประกาศ</em></p>
            </div>
        </section>
    </main>

    <footer>
        © 2025 มือถือ: ระบบจัดการคีย์ + ประกาศ
    </footer>

    <!-- Modal: Login (Owner Authentication) -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h3>เข้าสู่ระบบ (เจ้าของ)</h3>
            <input type="password" id="ownerPasswordInput" placeholder="รหัสผ่านเจ้าของ" />
            <button id="confirmLoginButton">ยืนยัน</button>
            <button id="cancelLoginButton" style="background-color: #dc3545; margin-top: 4px;">ยกเลิก</button>
            <div id="lockoutMessage" class="lockout-message" style="display: none;">
                ถูกล็อคชั่วคราว ลองอีกครั้งในอีกสักครู่
            </div>
        </div>
    </div>

    <!-- Modal: Edit Expiry / Uses -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3>เปลี่ยนวันหมดอายุ / จำนวนครั้งใช้งาน</h3>
            <select id="editExpirySelect">
                <option value="1">หมดอายุใน 1 วัน</option>
                <option value="7">หมดอายุใน 7 วัน</option>
                <option value="30">หมดอายุใน 30 วัน</option>
                <option value="90">หมดอายุใน 90 วัน</option>
            </select>
            <input type="number" id="editMaxUsesInput" placeholder="จำนวนครั้งใช้งาน" min="1" />
            <button id="confirmEditButton">บันทึก</button>
            <button id="cancelEditButton" style="background-color: #dc3545; margin-top: 4px;">ยกเลิก</button>
        </div>
    </div>

    <script>
        // ====== ตัวแปรหลัก ======
        let isOwner = false;
        const OWNER_PASSWORD_HASH = "5f4dcc3b5aa765d61d8327deb882cf99"; // MD5 ของ "password"
        let editingKeyValue = null;
        let failedAttempts = parseInt(localStorage.getItem("failedAttempts")) || 0;
        let lockoutUntil = localStorage.getItem("lockoutUntil") || null;

        document.addEventListener("DOMContentLoaded", () => {
            // ปุ่ม Auth
            const loginButton = document.getElementById("loginButton");
            const logoutButton = document.getElementById("logoutButton");
            // Modal Auth
            const loginModal = document.getElementById("loginModal");
            const ownerPasswordInput = document.getElementById("ownerPasswordInput");
            const confirmLoginButton = document.getElementById("confirmLoginButton");
            const cancelLoginButton = document.getElementById("cancelLoginButton");
            const lockoutMessage = document.getElementById("lockoutMessage");

            // Edit Modal
            const editModal = document.getElementById("editModal");
            const editMaxUsesInput = document.getElementById("editMaxUsesInput");
            const editExpirySelect = document.getElementById("editExpirySelect");
            const confirmEditButton = document.getElementById("confirmEditButton");
            const cancelEditButton = document.getElementById("cancelEditButton");

            // Tabs
            const tabKey = document.getElementById("tabKey");
            const tabAnnounce = document.getElementById("tabAnnounce");
            const keySection = document.getElementById("keySection");
            const announceSection = document.getElementById("announceSection");

            // Key Section Elements
            const generatedKeyElement = document.getElementById("generatedKey");
            const expirySelect = document.getElementById("expirySelect");
            const maxUsesInput = document.getElementById("maxUsesInput");
            const generateKeyButton = document.getElementById("generateKeyButton");
            const cmdInput = document.getElementById("cmdInput");
            const cmdSubmit = document.getElementById("cmdSubmit");
            const searchInput = document.getElementById("searchInput");
            const keyTable = document.getElementById("keyTable");
            const keyTableBody = keyTable.querySelector("tbody");
            const notifySection = document.getElementById("notifySection");

            // Announce Section Elements
            const announceInput = document.getElementById("announceInput");
            const announceButton = document.getElementById("announceButton");
            const announceList = document.getElementById("announceList");

            // เช็คล็อคเอาต์ก่อนเริ่ม
            checkLockout();

            // โหลดสถานะล็อกอินจาก localStorage
            if (localStorage.getItem("isOwnerLoggedIn") === "true") {
                isOwner = true;
            }

            // โหลดคีย์จาก localStorage
            function loadKeys() {
                const raw = localStorage.getItem("allKeys");
                return raw ? JSON.parse(raw) : [];
            }
            // บันทึกคีย์ลง localStorage
            function saveKeys(arr) {
                localStorage.setItem("allKeys", JSON.stringify(arr));
            }
            // บันทึกกิจกรรม
            function logActivity(text) {
                const p = document.createElement("p");
                const time = new Date().toLocaleString("th-TH");
                p.textContent = `[${time}] ${text}`;
                notifySection.prepend(p);
                // เก็บใน localStorage (ไม่เกิน 100 รายการ)
                const rawLogs = localStorage.getItem("activityLogs");
                const arr = rawLogs ? JSON.parse(rawLogs) : [];
                arr.unshift(p.textContent);
                localStorage.setItem("activityLogs", JSON.stringify(arr.slice(0, 100)));
            }
            // โหลดกิจกรรมเก่า
            function loadActivityLogs() {
                const raw = localStorage.getItem("activityLogs");
                if (!raw) return;
                const arr = JSON.parse(raw);
                arr.forEach(txt => {
                    const p = document.createElement("p");
                    p.textContent = txt;
                    notifySection.appendChild(p);
                });
            }

            // แสดงตารางคีย์ทั้งหมด (รองรับค้นหา)
            function renderKeyTable() {
                const allKeys = loadKeys();
                const filter = searchInput.value.trim().toLowerCase();
                const filtered = allKeys.filter(item => item.value.toLowerCase().includes(filter));
                if (filtered.length === 0) {
                    keyTable.style.display = "none";
                    return;
                }
                keyTable.style.display = "table";
                keyTableBody.innerHTML = "";
                const now = new Date();
                filtered.forEach(item => {
                    const tr = document.createElement("tr");
                    // คีย์
                    const tdKey = document.createElement("td");
                    tdKey.textContent = item.value;
                    tr.appendChild(tdKey);
                    // สถานะ & remaining uses
                    const tdStatus = document.createElement("td");
                    const tdUses = document.createElement("td");
                    let statusText = "";
                    let statusClass = "";
                    const expiry = new Date(item.expiry);
                    if (item.remainingUses <= 0) {
                        statusText = "ใช้จนหมด";
                        statusClass = "status-used";
                    } else if (expiry < now) {
                        statusText = "หมดอายุ";
                        statusClass = "status-expired";
                    } else {
                        statusText = "ยังใช้ได้";
                        statusClass = "status-unused";
                    }
                    tdStatus.textContent = statusText;
                    tdStatus.classList.add(statusClass);
                    tdUses.textContent = item.remainingUses;
                    tr.appendChild(tdStatus);
                    tr.appendChild(tdUses);
                    // สร้างเมื่อ
                    const tdCreated = document.createElement("td");
                    tdCreated.textContent = new Date(item.created).toLocaleString("th-TH");
                    tr.appendChild(tdCreated);
                    // หมดอายุ
                    const tdExpiry = document.createElement("td");
                    tdExpiry.textContent = expiry.toLocaleDateString("th-TH");
                    tr.appendChild(tdExpiry);
                    // ปุ่มจัดการ
                    const tdActions = document.createElement("td");
                    if (isOwner) {
                        const btnExpiry = document.createElement("button");
                        btnExpiry.textContent = "เปลี่ยนวัน";
                        btnExpiry.classList.add("action-btn");
                        btnExpiry.addEventListener("click", () => openEditModal(item.value));
                        tdActions.appendChild(btnExpiry);

                        const btnDelete = document.createElement("button");
                        btnDelete.textContent = "ลบ";
                        btnDelete.classList.add("action-btn");
                        btnDelete.addEventListener("click", () => deleteKey(item.value));
                        tdActions.appendChild(btnDelete);
                    } else {
                        tdActions.textContent = "-";
                    }
                    tr.appendChild(tdActions);
                    keyTableBody.appendChild(tr);
                });
            }

            // 
                                  function createNewKey() {
                const allKeys = loadKeys();
                const newValue = generateRandomKey();
                const created = new Date().toISOString();
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + parseInt(expirySelect.value));
                const maxUses = Math.max(1, parseInt(maxUsesInput.value) || 1);
                const newItem = {
                    value: newValue,
                    created,
                    expiry: expiryDate.toISOString(),
                    maxUses,
                    remainingUses: maxUses
                };
                allKeys.push(newItem);
                saveKeys(allKeys);
                generatedKeyElement.textContent = newValue;
                logActivity(`สร้างคีย์: ${newValue} (หมดอายุ ${expiryDate.toLocaleDateString("th-TH")}, ใช้งาน ${maxUses} ครั้ง)`);
                renderKeyTable();
            }

            // เปิด modal เปลี่ยน expiry / uses
            function openEditModal(keyValue) {
                const allKeys = loadKeys();
                const item = allKeys.find(i => i.value === keyValue);
                if (!item) return;
                editingKeyValue = keyValue;
                const daysLeft = Math.ceil((new Date(item.expiry) - new Date()) / (1000 * 60 * 60 * 24));
                if (daysLeft <= 1) editExpirySelect.value = "1";
                else if (daysLeft <= 7) editExpirySelect.value = "7";
                else if (daysLeft <= 30) editExpirySelect.value = "30";
                else editExpirySelect.value = "90";
                editMaxUsesInput.value = item.remainingUses;
                editModal.style.display = "flex";
            }
            function confirmEdit() {
                const allKeys = loadKeys();
                const item = allKeys.find(i => i.value === editingKeyValue);
                if (!item) return;
                const newMaxUses = Math.max(1, parseInt(editMaxUsesInput.value) || 1);
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + parseInt(editExpirySelect.value));
                item.maxUses = newMaxUses;
                item.remainingUses = Math.min(item.remainingUses, newMaxUses);
                item.expiry = expiryDate.toISOString();
                saveKeys(allKeys);
                generatedKeyElement.textContent = item.value;
                logActivity(`เปลี่ยนคีย์ ${item.value} → หมดอายุ ${expiryDate.toLocaleDateString("th-TH")}, คงเหลือ ${item.remainingUses}`);
                renderKeyTable();
                closeEditModal();
            }
            function deleteKey(keyValue) {
                let allKeys = loadKeys();
                allKeys = allKeys.filter(i => i.value !== keyValue);
                saveKeys(allKeys);
                logActivity(`ลบคีย์: ${keyValue}`);
                renderKeyTable();
                if (allKeys.length === 0) {
                    generatedKeyElement.textContent = "ยังไม่มีคีย์";
                }
            }
            // ปิด editModal
            function closeEditModal() {
                editModal.style.display = "none";
                editingKeyValue = null;
            }

            // ดาวน์โหลด CSV
            function exportToCSV() {
                const allKeys = loadKeys();
                if (allKeys.length === 0) return;
                let csvContent = "คีย์,สถานะ,คงเหลือ,สร้างเมื่อ,หมดอายุ,จำนวนครั้ง\n";
                const now = new Date();
                allKeys.forEach(item => {
                    const expiry = new Date(item.expiry);
                    let statusLabel = item.remainingUses <= 0 ? "ใช้จนหมด" : (expiry < now ? "หมดอายุ" : "ยังใช้ได้");
                    csvContent += `${item.value},${statusLabel},${item.remainingUses},${new Date(item.created).toLocaleString("th-TH")},${expiry.toLocaleDateString("th-TH")},${item.maxUses}\n`;
                });
                const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.setAttribute("href", url);
                a.setAttribute("download", "keys_export.csv");
                a.click();
                logActivity("ดาวน์โหลด CSV คีย์ทั้งหมด");
            }

            // ตรวจสอบคีย์
            const verifyKeyInput = document.createElement("input"); // placeholder, not used visually
            const verifyResult = document.createElement("div"); // placeholder
            function verifyKey() {
                const input = verifyKeyInput.value.trim();
                if (input === "") return;
                const allKeys = loadKeys();
                const found = allKeys.find(item => item.value === input);
                if (!found) {
                    verifyResult.textContent = "ไม่พบคีย์นี้";
                    verifyResult.style.color = "#dc3545";
                    logActivity(`ตรวจสอบคีย์ล้มเหลว: ไม่พบ ${input}`);
                    return;
                }
                const now = new Date();
                const expiry = new Date(found.expiry);
                if (expiry < now) {
                    verifyResult.textContent = "คีย์หมดอายุ";
                    verifyResult.style.color = "#ffc107";
                    logActivity(`ตรวจสอบคีย์ ${input}: หมดอายุ`);
                    return;
                }
                if (found.remainingUses <= 0) {
                    verifyResult.textContent = "ใช้จนหมดแล้ว";
                    verifyResult.style.color = "#ffc107";
                    logActivity(`ตรวจสอบคีย์ ${input}: ใช้จนหมด`);
                    return;
                }
                found.remainingUses -= 1;
                saveKeys(allKeys);
                renderKeyTable();
                verifyResult.textContent = `คีย์ถูกต้อง คงเหลือ ${found.remainingUses} ครั้ง`;
                verifyResult.style.color = "#28a745";
                logActivity(`ตรวจสอบคีย์สำเร็จ: ${input} (คงเหลือ ${found.remainingUses})`);
            }

            // แพลตฟอร์มคำสั่ง (owner mode)
            function processCommand(cmd) {
                const parts = cmd.trim().split(" ");
                const action = parts[0]?.toLowerCase();
                const allKeys = loadKeys();
                if (action === "create") {
                    createNewKey();
                } else if (action === "delete" && parts[1]) {
                    deleteKey(parts[1]);
                } else if ((action === "setexpiry" || action === "expire") && parts[1] && parts[2]) {
                    const keyVal = parts[1];
                    const days = parseInt(parts[2]);
                    const item = allKeys.find(i => i.value === keyVal);
                    if (item && !isNaN(days)) {
                        const ext = new Date();
                        ext.setDate(ext.getDate() + days);
                        item.expiry = ext.toISOString();
                        saveKeys(allKeys);
                        logActivity(`คำสั่ง: เปลี่ยนวันหมดอายุ ${keyVal} → ${ext.toLocaleDateString("th-TH")}`);
                        renderKeyTable();
                    }
                } else if ((action === "setuses" || action === "uses") && parts[1] && parts[2]) {
                    const keyVal = parts[1];
                    const uses = parseInt(parts[2]);
                    const item = allKeys.find(i => i.value === keyVal);
                    if (item && !isNaN(uses) && uses > 0) {
                        item.maxUses = uses;
                        item.remainingUses = Math.min(item.remainingUses, uses);
                        saveKeys(allKeys);
                        logActivity(`คำสั่ง: เปลี่ยนจำนวนครั้ง ${keyVal} → ${uses}`);
                        renderKeyTable();
                    }
                } else if (action === "export") {
                    exportToCSV();
                } else {
                    alert("คำสั่งไม่ถูกต้อง");
                }
            }

            // จัดการประกาศ
            function loadAnnouncements() {
                const raw = localStorage.getItem("announcements");
                if (!raw) return;
                const arr = JSON.parse(raw);
                announceList.innerHTML = "";
                arr.forEach(txt => {
                    const p = document.createElement("p");
                    p.textContent = txt;
                    announceList.appendChild(p);
                });
            }
            function addAnnouncement(text) {
                const raw = localStorage.getItem("announcements");
                const arr = raw ? JSON.parse(raw) : [];
                const time = new Date().toLocaleString("th-TH");
                const fullText = `[${time}] ${text}`;
                arr.unshift(fullText);
                localStorage.setItem("announcements", JSON.stringify(arr.slice(0, 50)));
                loadAnnouncements();
                logActivity(`ประกาศ: ${text}`);
            }

            // สุ่มคีย์ 8 ตัวอักษร
            function generateRandomKey() {
                const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
                let result = "";
                for (let i = 0; i < 8; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return "KEY-" + result;
            }

            // toggle owner elements
            function updateOwnerUI() {
                if (isOwner) {
                    cmdInput.style.display = "block";
                    cmdSubmit.style.display = "block";
                    announceButton.style.display = "block";
                } else {
                    cmdInput.style.display = "none";
                    cmdSubmit.style.display = "none";
                    announceButton.style.display = "none";
                }
                renderKeyTable();
            }

            // สลับปุ่ม Auth
            function toggleAuthButtons() {
                if (isOwner) {
                    loginButton.style.display = "none";
                    logoutButton.style.display = "inline-block";
                } else {
                    loginButton.style.display = "inline-block";
                    logoutButton.style.display = "none";
                }
                updateOwnerUI();
            }

            // เช็คล็อคเอาต์
            function checkLockout() {
                const lockout = localStorage.getItem("lockoutUntil");
                if (lockout && new Date() < new Date(lockout)) {
                    isOwner = false;
                } else {
                    localStorage.removeItem("lockoutUntil");
                    localStorage.setItem("failedAttempts", "0");
                }
            }

            // ฟังก์ชัน MD5 (สำหรับแฮชรหัสผ่าน)
            function md5(string) {
                function RotateLeft(lValue, iShiftBits) {
                    return (lValue << iShiftBits) | (lValue >>> (32 - iShiftBits));
                }
                function AddUnsigned(lX, lY) {
                    let lX4, lY4, lX8, lY8, lResult;
                    lX8 = lX & 0x80000000;
                    lY8 = lY & 0x80000000;
                    lX4 = lX & 0x40000000;
                    lY4 = lY & 0x40000000;
                    lResult = (lX & 0x3fffffff) + (lY & 0x3fffffff);
                    if (lX4 & lY4) return lResult ^ 0x80000000 ^ lX8 ^ lY8;
                    if (lX4 | lY4) {
                        if (lResult & 0x40000000) return lResult ^ 0xc0000000 ^ lX8 ^ lY8;
                        else return lResult ^ 0x40000000 ^ lX8 ^ lY8;
                    } else {
                        return lResult ^ lX8 ^ lY8;
                    }
                }
                function F(x, y, z) { return (x & y) | (~x & z); }
                function G(x, y, z) { return (x & z) | (y & ~z); }
                function H(x, y, z) { return x ^ y ^ z; }
                function I(x, y, z) { return y ^ (x | ~z); }
                function FF(a, b, c, d, x, s, ac) {
                    a = AddUnsigned(a, AddUnsigned(AddUnsigned(F(b, c, d), x), ac));
                    return AddUnsigned(RotateLeft(a, s), b);
                }
                function GG(a, b, c, d, x, s, ac) {
                    a = AddUnsigned(a, AddUnsigned(AddUnsigned(G(b, c, d), x), ac));
                    return AddUnsigned(RotateLeft(a, s), b);
                }
                function HH(a, b, c, d, x, s, ac) {
                    a = AddUnsigned(a, AddUnsigned(AddUnsigned(H(b, c, d), x), ac));
                    return AddUnsigned(RotateLeft(a, s), b);
                }
                function II(a, b, c, d, x, s, ac) {
                    a = AddUnsigned(a, AddUnsigned(AddUnsigned(I(b, c, d), x), ac));
                    return AddUnsigned(RotateLeft(a, s), b);
                }
                function ConvertToWordArray(str) {
                    let lWordCount;
                    const lMessageLength = str.length;
                    const lNumberOfWordsTemp1 = lMessageLength + 8;
                    const lNumberOfWordsTemp2 = (lNumberOfWordsTemp1 - (lNumberOfWordsTemp1 % 64)) / 64;
                    const lNumberOfWords = (lNumberOfWordsTemp2 + 1) * 16;
                    const lWordArray = new Array(lNumberOfWords - 1);
                    let lBytePosition = 0;
                    let lByteCount = 0;
                    while (lByteCount < lMessageLength) {
                        lWordCount = (lByteCount - (lByteCount % 4)) / 4;
                        lBytePosition = (lByteCount % 4) * 8;
                        lWordArray[lWordCount] = (lWordArray[lWordCount] | (str.charCodeAt(lByteCount) << lBytePosition));
                        lByteCount++;
                    }
                    lWordCount = (lByteCount - (lByteCount % 4)) / 4;
                    lBytePosition = (lByteCount % 4) * 8;
                    lWordArray[lWordCount] = lWordArray[lWordCount] | (0x80 << lBytePosition);
                    lWordArray[lNumberOfWords - 2] = lMessageLength << 3;
                    lWordArray[lNumberOfWords - 1] = lMessageLength >>> 29;
                    return lWordArray;
                }
                function WordToHex(lValue) {
                    let WordToHexValue = "", WordToHexValueTemp = "", lByte, lCount;
                    for (lCount = 0; lCount <= 3; lCount++) {
                        lByte = (lValue >>> (lCount * 8)) & 255;
                        WordToHexValueTemp = "0" + lByte.toString(16);
                        WordToHexValue += WordToHexValueTemp.substr(WordToHexValueTemp.length - 2, 2);
                    }
                    return WordToHexValue;
                }
                function Utf8Encode(str) {
                    str = str.replace(/\r\n/g, "\n");
                    let utftext = "";
                    for (let n = 0; n < str.length; n++) {
                        const c = str.charCodeAt(n);
                        if (c < 128) {
                            utftext += String.fromCharCode(c);
                        } else if ((c > 127) && (c < 2048)) {
                            utftext += String.fromCharCode((c >> 6) | 192);
                            utftext += String.fromCharCode((c & 63) | 128);
                        } else {
                            utftext += String.fromCharCode((c >> 12) | 224);
                            utftext += String.fromCharCode(((c >> 6) & 63) | 128);
                            utftext += String.fromCharCode((c & 63) | 128);
                        }
                    }
                    return utftext;
                }
                let x = [];
                let k, AA, BB, CC, DD, a, b, c, d;
                const S11 = 7, S12 = 12, S13 = 17, S14 = 22;
                const S21 = 5, S22 = 9, S23 = 14, S24 = 20;
                const S31 = 4, S32 = 11, S33 = 16, S34 = 23;
                const S41 = 6, S42 = 10, S43 = 15, S44 = 21;
                string = Utf8Encode(string);
                x = ConvertToWordArray(string);
                a = 0x67452301; b = 0xefcdab89; c = 0x98badcfe; d = 0x10325476;
                for (k = 0; k < x.length; k += 16) {
                    AA = a; BB = b; CC = c; DD = d;
                    a = FF(a, b, c, d, x[k + 0], S11, 0xd76aa478);
                    d = FF(d, a, b, c, x[k + 1], S12, 0xe8c7b756);
                    c = FF(c, d, a, b, x[k + 2], S13, 0x242070db);
                    b = FF(b, c, d, a, x[k + 3], S14, 0xc1bdceee);
                    a = FF(a, b, c, d, x[k + 4], S11, 0xf57c0faf);
                    d = FF(d, a, b, c, x[k + 5], S12, 0x4787c62a);
                    c = FF(c, d, a, b, x[k + 6], S13, 0xa8304613);
                    b = FF(b, c, d, a, x[k + 7], S14, 0xfd469501);
                    a = FF(a, b, c, d, x[k + 8], S11, 0x698098d8);
                    d = FF(d, a, b, c, x[k + 9], S12, 0x8b44f7af);
                    c = FF(c, d, a, b, x[k + 10], S13, 0xffff5bb1);
                    b = FF(b, c, d, a, x[k + 11], S14, 0x895cd7be);
                    a = FF(a, b, c, d, x[k + 12], S11, 0x6b901122);
                    d = FF(d, a, b, c, x[k + 13], S12, 0xfd987193);
                    c = FF(c, d, a, b, x[k + 14], S13, 0xa679438e);
                    b = FF(b, c, d, a, x[k + 15], S14, 0x49b40821);
                    a = GG(a, b, c, d, x[k + 1], S21, 0xf61e2562);
                    d = GG(d, a, b, c, x[k + 6], S22, 0xc040b340);
                    c = GG(c, d, a, b, x[k + 11], S23, 0x265e5a51);
                    b = GG(b, c, d, a, x[k + 0], S24, 0xe9b6c7aa);
                    a = GG(a, b, c, d, x[k + 5], S21, 0xd62f105d);
                    d = GG(d, a, b, c, x[k + 10], S22, 0x02441453);
                    c = GG(c, d, a, b, x[k + 15], S23, 0xd8a1e681);
                    b = GG(b, c, d, a, x[k + 4], S24, 0xe7d3fbc8);
                    a = GG(a, b, c, d, x[k + 9], S21, 0x21e1cde6);
                    d = GG(d, a, b, c, x[k + 14], S22, 0xc33707d6);
                    c = GG(c, d, a, b, x[k + 3], S23, 0xf4d50d87);
                    b = GG(b, c, d, a, x[k + 8], S24, 0x455a14ed);
                    a = GG(a, b, c, d, x[k + 13], S21, 0xa9e3e905);
                    d = GG(d, a, b, c, x[k + 2], S22, 0xfcefa3f8);
                    c = GG(c, d, a, b, x[k + 7], S23, 0x676f02d9);
                    b = GG(b, c, d, a, x[k + 12], S24, 0x8d2a4c8a);
                    a = HH(a, b, c, d, x[k + 5], S31, 0xfffa3942);
                    d = HH(d, a, b, c, x[k + 8], S32, 0x8771f681);
                    c = HH(c, d, a, b, x[k + 11], S33, 0x6d9d6122);
                    b = HH(b, c, d, a, x[k + 14], S34, 0xfde5380c);
                    a = HH(a, b, c, d, x[k + 1], S31, 0xa4beEA44);
                    d = HH(d, a, b, c, x[k + 4], S32, 0x4bdecfa9);
                    c = HH(c, d, a, b, x[k + 7], S33, 0xf6bb4b60);
                    b = HH(b, c, d, a, x[k + 10], S34, 0xbebfbc70);
                    a = HH(a, b, c, d, x[k + 13], S31, 0x289b7ec6);
                    d = HH(d, a, b, c, x[k + 0], S32, 0xeaa127fa);
                    c = HH(c, d, a, b, x[k + 3], S33, 0xd4ef3085);
                    b = HH(b, c, d, a, x[k + 6], S34, 0x04881d05);
                    a = HH(a, b, c, d, x[k + 9], S31, 0xd9d4d039);
                    d = HH(d, a, b, c, x[k + 12], S32, 0xe6db99e5);
                    c = HH(c, d, a, b, x[k + 15], S33, 0x1fa27cf8);
                    b = HH(b, c, d, a, x[k + 2], S34, 0xc4ac5665);
                    a = II(a, b, c, d, x[k + 0], S41, 0xf4292244);
                    d = II(d, a, b, c, x[k + 7], S42, 0x432aff97);
                    c = II(c, d, a, b, x[k + 14], S43, 0xab9423a7);
                    b = II(b, c, d, a, x[k + 5], S44, 0xfc93a039);
                    a = II(a, b, c, d, x[k + 12], S41, 0x655b59c3);
                    d = II(d, a, b, c, x[k + 3], S42, 0x8f0ccc92);
                    c = II(c, d, a, b, x[k + 10], S43, 0xffeff47d);
                    b = II(b, c, d, a, x[k + 1], S44, 0x85845dd1);
                    a = II(a, b, c, d, x[k + 8], S41, 0x6fa87e4f);
                    d = II(d, a, b, c, x[k + 15], S42, 0xfe2ce6e0);
                    c = II(c, d, a, b, x[k + 6], S43, 0xa3014314);
                    b = II(b, c, d, a, x[k + 13], S44, 0x4e0811a1);
                    a = II(a, b, c, d, x[k + 4], S41, 0xf7537e82);
                    d = II(d, a, b, c, x[k + 11], S42, 0xbd3af235);
                    c = II(c, d, a, b, x[k + 2], S43, 0x2ad7d2bb);
                    b = II(b, c, d, a, x[k + 9], S44, 0xeb86d391);
                    a = AddUnsigned(a, AA);
                    b = AddUnsigned(b, BB);
                    c = AddUnsigned(c, CC);
                    d = AddUnsigned(d, DD);
                }
                const temp = WordToHex(a) + WordToHex(b) + WordToHex(c) + WordToHex(d);
                return temp.toLowerCase();
            }

            // ====== Event Listeners ======

            // Auth: เปิด modal
            loginButton.addEventListener("click", () => {
                if (lockoutUntil && new Date() < new Date(lockoutUntil)) {
                    lockoutMessage.style.display = "block";
                    return;
                }
                loginModal.style.display = "flex";
                ownerPasswordInput.value = "";
                ownerPasswordInput.focus();
                lockoutMessage.style.display = "none";
            });
            // Auth: ยืนยันรหัส
            confirmLoginButton.addEventListener("click", () => {
                const pwd = ownerPasswordInput.value.trim();
                if (pwd === "") return;
                if (md5(pwd) === OWNER_PASSWORD_HASH) {
                    isOwner = true;
                    localStorage.setItem("isOwnerLoggedIn", "true");
                    failedAttempts = 0;
                    localStorage.setItem("failedAttempts", "0");
                    lockoutUntil = null;
                    localStorage.removeItem("lockoutUntil");
                    loginModal.style.display = "none";
                    logActivity("เจ้าของเข้าสู่ระบบสำเร็จ");
                    toggleAuthButtons();
                } else {
                    failedAttempts += 1;
                    localStorage.setItem("failedAttempts", failedAttempts.toString());
                    if (failedAttempts >= 3) {
                        const until = new Date();
                        until.setMinutes(until.getMinutes() + 5);
                        lockoutUntil = until.toISOString();
                        localStorage.setItem("lockoutUntil", lockoutUntil);
                        lockoutMessage.textContent = "ล็อค 5 นาที";
                        lockoutMessage.style.display = "block";
                    } else {
                        alert("รหัสผ่านไม่ถูกต้อง");
                    }
                    ownerPasswordInput.value = "";
                    ownerPasswordInput.focus();
                }
            });
            cancelLoginButton.addEventListener("click", () => {
                loginModal.style.display = "none";
            });
            logoutButton.addEventListener("click", () => {
                isOwner = false;
                localStorage.setItem("isOwnerLoggedIn", "false");
                logActivity("เจ้าของออกจากระบบ");
                toggleAuthButtons();
            });

            tabKey.addEventListener("click", () => {
                tabKey.classList.add("active");
                tabAnnounce.classList.remove("active");
                keySection.classList.add("active");
                announceSection.classList.remove("active");
            });
            tabAnnounce.addEventListener("click", () => {
                tabAnnounce.classList.add("active");
                tabKey.classList.remove("active");
                announceSection.classList.add("active");
                keySection.classList.remove("active");
            });

            generateKeyButton.addEventListener("click", () => {
                if (!isOwner) {
                    alert("ต้องเป็นโหมดเจ้าของเท่านั้น");
                    return;
                }
                createNewKey();
            });
            searchInput.addEventListener("input", renderKeyTable);

            cmdSubmit.addEventListener("click", () => {
                const cmd = cmdInput.value.trim();
                if (cmd === "") return;
                processCommand(cmd);
                cmdInput.value = "";
            });

            announceButton.addEventListener("click", () => {
                const text = announceInput.value.trim();
                if (!text) return;
                addAnnouncement(text);
                announceInput.value = "";
            });

            confirmEditButton.addEventListener("click", confirmEdit);
            cancelEditButton.addEventListener("click", () => {
                closeEditModal();
            });

            window.addEventListener("click", (e) => {
                if (e.target === loginModal) loginModal.style.display = "none";
                if (e.target === editModal) closeEditModal();
            });

            loadActivityLogs();
            loadAnnouncements();
            toggleAuthButtons();
            renderKeyTable();
        });
    </script>
</body>
</html>
