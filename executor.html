<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YANZZ EXECUTOR</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-dark: #0a0a0a;
      --card-bg-dark: rgba(20, 20, 20, 0.9);
      --text-dark: #f0f0f0;
      --accent: #e91e63;
      --accent2: #9c27b0;
      --border-radius: 10px;
      --shadow-color: rgba(0, 0, 0, 0.2);
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: radial-gradient(circle at top left, #121212, #000000);
      color: var(--text-dark);
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
    }
    .controls {
      width: 100%;
      max-width: 900px;
      margin: 20px auto;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      justify-content: center;
      background: var(--card-bg-dark);
      padding: 12px;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px var(--shadow-color);
    }
    .controls select,
    .controls button {
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      border: 2px solid var(--accent);
      background: transparent;
      color: inherit;
      font-size: 0.9rem;
      outline: none;
      transition: background 0.2s, color 0.2s;
    }
    .controls button {
      cursor: pointer;
      background: var(--card-bg-dark);
    }
    .controls button:hover {
      background: var(--accent);
      color: #fff;
    }
    .section-container {
      width: 100%;
      max-width: 900px;
      margin-bottom: 40px;
      padding: 0 10px;
    }
    .platform-section {
      margin-bottom: 1.5rem;
      border-radius: var(--border-radius);
      overflow: hidden;
      background: var(--card-bg-dark);
      box-shadow: 0 4px 12px var(--shadow-color);
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background: rgba(30, 30, 30, 0.8);
      cursor: pointer;
    }
    .section-header h3 {
      font-size: 1.2rem;
      color: var(--accent2);
      text-shadow: 0 0 4px var(--accent2);
    }
    .section-header .toggle-icon {
      font-size: 1.2rem;
      user-select: none;
    }
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 1rem;
      padding: 1rem;
    }
    .card {
      background: var(--card-bg-dark);
      border-radius: var(--border-radius);
      padding: 1rem;
      box-shadow: 0 4px 12px var(--shadow-color);
      position: relative;
      overflow: hidden;
      transition: transform 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 18px var(--shadow-color);
    }
    .card img {
      max-width: 80%;
      max-height: 100px;
      border-radius: var(--border-radius);
      margin-bottom: 0.75rem;
      object-fit: cover;
    }
    .card h2 {
      font-size: 1.2rem;
      color: var(--accent);
      margin-bottom: 6px;
      text-shadow: 0 0 4px var(--accent);
      text-align: center;
    }
    .card p {
      font-size: 0.9rem;
      color: #ccc;
      margin-bottom: 6px;
      text-align: center;
    }
    .card .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 10px;
      width: 100%;
    }
    .card .actions button {
      flex: 1;
      padding: 0.5rem;
      border: none;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: transform 0.2s, background 0.2s;
      background: var(--card-bg-dark);
      color: inherit;
    }
    .card .actions button:hover {
      transform: scale(1.05);
      background: var(--accent);
      color: #fff;
    }
    .btn-copy   { background: var(--accent); color: #fff; }
    .btn-edit   { background: var(--accent2); color: #000; }
    .btn-delete { background: #f44336; color: #fff; }
    .btn-check  { background: #4caf50; color: #fff; }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8);
      align-items: center; justify-content: center;
      z-index: 1000;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: var(--card-bg-dark);
      border-radius: var(--border-radius);
      padding: 2rem;
      width: 90%; max-width: 480px;
      box-shadow: 0 4px 20px var(--shadow-color);
      animation: fadeIn 0.3s ease-out;
      position: relative;
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .modal-content h2 {
      grid-column: 1 / -1;
      margin-bottom: 0.5rem;
      color: var(--accent);
      text-align: center;
      font-size: 1.5rem;
    }
    .modal-content label {
      font-size: 0.9rem;
      color: inherit;
      margin-top: 0.5rem;
    }
    .modal-content input,
    .modal-content select {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid var(--accent);
      border-radius: 4px;
      background: transparent;
      color: inherit;
      outline: none;
      transition: background 0.2s;
      font-size: 0.9rem;
    }
    .modal-content select[multiple] {
      height: 90px;
    }
    .modal-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    .modal-content .form-actions {
      grid-column: 1 / -1;
      margin-top: 1rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }
    .modal-content .form-actions button {
      padding: 0.6rem 1.2rem;
      border: 2px solid var(--accent);
      border-radius: 4px;
      background: transparent;
      color: inherit;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 0.9rem;
    }
    .modal-content .form-actions button:hover {
      background: var(--accent);
      color: #fff;
    }
    .modal-content .close-modal {
      position: absolute;
      top: 1rem; right: 1rem;
      font-size: 1.5rem;
      color: inherit;
      cursor: pointer;
    }
    #toast {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: #fff;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 1001;
      text-shadow: 0 0 8px #000;
      font-size: 0.9rem;
    }
    #toast.show {
      opacity: 1;
      pointer-events: auto;
    }
    .empty-state {
      text-align: center;
      color: #bbb;
      font-size: 1.1rem;
      padding: 40px;
    }
    @media (max-width: 600px) {
      .controls { flex-direction: column; align-items: stretch; }
      .card { padding: 0.75rem; }
      .modal-content { padding: 1rem; grid-template-columns: 1fr; }
      .modal-row { grid-template-columns: 1fr; }
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
</head>
<body>

  <!-- Controls -->
  <div class="controls">
    <select id="filter-platform" aria-label="Platform Filter">
      <option value="All">All</option>
      <option value="Android">Android</option>
      <option value="iOS">iOS</option>
      <option value="Windows">Windows</option>
      <option value="macOS">macOS</option>
    </select>
    <button id="btn-add">Add Executor</button>
  </div>

  <!-- Card Sections Container -->
  <div class="section-container" id="section-container"></div>

  <!-- Modal for Add/Edit -->
  <div class="modal" id="modal-form" role="dialog" aria-modal="true">
    <div class="modal-content">
      <span class="close-modal" id="close-modal" aria-label="Close">&times;</span>
      <h2 id="modal-title">Add Executor</h2>
      <div class="modal-row">
        <div>
          <label for="executor-name">Executor Name</label>
          <input type="text" id="executor-name" placeholder="e.g. Arceus X" aria-label="Executor Name" />
        </div>
        <div>
          <label for="executor-version">Version</label>
          <input type="text" id="executor-version" placeholder="e.g. v3.2.1" aria-label="Executor Version" />
        </div>
      </div>

      <label for="executor-platforms">Platforms</label>
      <select id="executor-platforms" multiple aria-label="Select Platforms">
        <option value="Android">Android</option>
        <option value="iOS">iOS</option>
        <option value="Windows">Windows</option>
        <option value="macOS">macOS</option>
      </select>

      <label for="executor-image">Select Image</label>
      <input type="file" id="executor-image" accept="image/*" aria-label="Executor Image" />

      <label for="executor-link">Download Link</label>
      <input type="url" id="executor-link" placeholder="https://" aria-label="Executor Link" />

      <div class="modal-row">
        <div>
          <label for="executor-status">Status</label>
          <select id="executor-status" aria-label="Status">
            <option value="Online">Online</option>
            <option value="Offline">Offline</option>
            <option value="Beta">Beta</option>
          </select>
        </div>
        <div></div>
      </div>

      <div class="form-actions">
        <button id="btn-cancel">Cancel</button>
        <button id="btn-save">Save</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
const firebaseConfig = {
  apiKey: "AIzaSyA_sh9fh7h1gGOurALEWJAq3Y-o7vSeaCM",
  authDomain: "yanzz-6e06c.firebaseapp.com",
  projectId: "yanzz-6e06c",
  storageBucket: "yanzz-6e06c.firebasestorage.app",
  messagingSenderId: "951083749698",
  appId: "1:951083749698:web:f83a7e01056127c69bf8db",
  measurementId: "G-SBTHKJL1NN"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
    firebase.initializeApp(firebaseConfig);

    firebase.firestore().settings({
      experimentalForceLongPolling: true
    });
    const db = firebase.firestore();
    let executors = [];
    let editDocId = null;
    let collapseState = {};
    let selectedImageData = "";
    let debounceDraftTimer = null;
    
    const cardContainer   = document.getElementById('section-container');
    const filterPlatform  = document.getElementById('filter-platform');
    const btnAdd          = document.getElementById('btn-add');
    const modal           = document.getElementById('modal-form');
    const closeModalBtn   = document.getElementById('close-modal');
    const modalTitle      = document.getElementById('modal-title');
    const nameInput       = document.getElementById('executor-name');
    const versionInput    = document.getElementById('executor-version');
    const platformsSelect = document.getElementById('executor-platforms');
    const imageInput      = document.getElementById('executor-image');
    const linkInput       = document.getElementById('executor-link');
    const statusSelect    = document.getElementById('executor-status');
    const btnSave         = document.getElementById('btn-save');
    const btnCancel       = document.getElementById('btn-cancel');
    const toast           = document.getElementById('toast');

    const PLATFORMS = ['Android','iOS','Windows','macOS'];

    function showToast(message) {
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    function copyLink(link) {
      navigator.clipboard.writeText(link)
        .then(() => showToast('Copied successfully'))
        .catch(() => showToast('Copy failed'));
    }

    function formatDate(timestamp) {
      if (!timestamp) return '';
      const d = timestamp.toDate();
      return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function saveDraft() {
      clearTimeout(debounceDraftTimer);
      debounceDraftTimer = setTimeout(() => {
        const draft = {
          name: nameInput.value.trim(),
          version: versionInput.value.trim(),
          platforms: [...platformsSelect.selectedOptions].map(opt => opt.value),
          link: linkInput.value.trim(),
          status: statusSelect.value,
          imageData: selectedImageData
        };
        localStorage.setItem('executorDraft', JSON.stringify(draft));
        showToast('Draft saved');
      }, 1000);
    }

    function loadDraft() {
      const data = localStorage.getItem('executorDraft');
      if (data) {
        try {
          const draft = JSON.parse(data);
          nameInput.value = draft.name || '';
          versionInput.value = draft.version || '';
          [...platformsSelect.options].forEach(opt => opt.selected = (draft.platforms || []).includes(opt.value));
          linkInput.value = draft.link || '';
          statusSelect.value = draft.status || 'Online';
          selectedImageData = draft.imageData || "";
          showToast('Draft loaded');
        } catch {}
      }
    }

    function clearDraft() {
      localStorage.removeItem('executorDraft');
      showToast('Draft cleared');
    }

    imageInput.addEventListener('change', event => {
      const file = event.target.files[0];
      if (!file) {
        selectedImageData = "";
        return;
      }
      const reader = new FileReader();
      reader.onload = e => {
        selectedImageData = e.target.result;
        showToast('Image selected');
      };
      reader.readAsDataURL(file);
    });

    async function fetchExecutors() {
      try {
        const snapshot = await db.collection('executors').orderBy('createdAt', 'desc').get();
        executors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderCards();
      } catch(err) {
        console.error('fetchExecutors failed:', err);
        showToast('Cannot fetch data');
      }
    }

    async function addExecutorToFirestore(exe) {
      return db.collection('executors').add(exe);
    }

    async function updateExecutorInFirestore(docId, exe) {
      return db.collection('executors').doc(docId).update(exe);
    }

    async function deleteExecutorFromFirestore(docId) {
      return db.collection('executors').doc(docId).delete();
    }

    function renderCards() {
      cardContainer.innerHTML = '';
      const platFilter = filterPlatform.value;

      const groups = {};
      PLATFORMS.forEach(p => groups[p] = []);
      executors.forEach(e => {
        e.platforms.forEach(p => {
          if (groups[p]) groups[p].push(e);
        });
      });

      PLATFORMS.forEach(platform => {
        const items = groups[platform].filter(e => (platFilter === 'All' || e.platforms.includes(platFilter)));
        if (items.length === 0) return;

        const section = document.createElement('div');
        section.className = 'platform-section';
        const header = document.createElement('div');
        header.className = 'section-header';
        header.innerHTML = `
          <h3>${platform} (${items.length})</h3>
          <span class="toggle-icon" data-platform="${platform}">
            ${collapseState[platform] ? '▼' : '▲'}
          </span>
        `;
        header.addEventListener('click', () => {
          collapseState[platform] = !collapseState[platform];
          renderCards();
        });
        section.appendChild(header);

        if (!collapseState[platform]) {
          const grid = document.createElement('div');
          grid.className = 'cards-grid';
          items.forEach(exe => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
              ${exe.imageData ? `<img src="${exe.imageData}" alt="${exe.name}"/>` : ''}
              <h2>${exe.name}</h2>
              <p><strong>Version:</strong> ${exe.version}</p>
              <p><strong>Status:</strong> ${exe.status}</p>
              ${exe.createdAt ? `<p><strong>Added:</strong> ${formatDate(exe.createdAt)}</p>` : ''}
              ${exe.updatedAt ? `<p><strong>Updated:</strong> ${formatDate(exe.updatedAt)}</p>` : ''}
              <div class="actions">
                <button class="btn-copy" aria-label="Copy Link">📋</button>
                <button class="btn-edit" aria-label="Edit Executor">✏️</button>
                <button class="btn-delete" aria-label="Delete Executor">🗑️</button>
                <button class="btn-check" aria-label="Check Link">🔗</button>
              </div>
            `;
            card.querySelector('.btn-copy').addEventListener('click', () => copyLink(exe.link));
            card.querySelector('.btn-edit').addEventListener('click', () => openModal('edit', exe.id));
            card.querySelector('.btn-delete').addEventListener('click', () => deleteExecutor(exe.id));
            card.querySelector('.btn-check').addEventListener('click', () => checkLink(exe.link));
            grid.appendChild(card);
          });
          section.appendChild(grid);
        }
        cardContainer.appendChild(section);
      });

      if (executors.length === 0) {
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'empty-state';
        emptyDiv.textContent = 'No executors yet 😭 Click “Add Executor” to start';
        cardContainer.appendChild(emptyDiv);
      }
    }

    function openModal(mode, docId = null) {
      modal.classList.add('active');
      nameInput.focus();
      imageInput.value = '';
      selectedImageData = "";
      if (mode === 'add') {
        modalTitle.textContent = 'Add Executor';
        nameInput.value = '';
        versionInput.value = '';
        [...platformsSelect.options].forEach(opt => opt.selected = false);
        linkInput.value = '';
        statusSelect.value = 'Online';
        editDocId = null;
        loadDraft();
      } else if (mode === 'edit') {
        const exe = executors.find(e => e.id === docId);
        if (!exe) return;
        modalTitle.textContent = 'Edit Executor';
        nameInput.value = exe.name;
        versionInput.value = exe.version;
        [...platformsSelect.options].forEach(opt => opt.selected = exe.platforms.includes(opt.value));
        linkInput.value = exe.link;
        statusSelect.value = exe.status;
        selectedImageData = exe.imageData || "";
        editDocId = docId;
        clearDraft();
      }
    }

    function closeModal() {
      modal.classList.remove('active');
      clearDraft();
    }

    btnSave.addEventListener('click', async () => {
      const name = nameInput.value.trim();
      const version = versionInput.value.trim();
      const platforms = [...platformsSelect.selectedOptions].map(opt => opt.value);
      const link = linkInput.value.trim();
      const status = statusSelect.value;
      if (!name || !version || platforms.length === 0 || !link) {
        showToast('Invalid input');
        return;
      }
      const exists = executors.some(e =>
        e.name.toLowerCase() === name.toLowerCase() &&
        e.version.toLowerCase() === version.toLowerCase() &&
        (editDocId === null || e.id !== editDocId)
      );
      if (exists) {
        showToast('Duplicate entry: same name and version');
        return;
      }
      const now = firebase.firestore.Timestamp.now();
      if (editDocId !== null) {
        await updateExecutorInFirestore(editDocId, {
          name, version, platforms, link, status,
          imageData: selectedImageData,
          updatedAt: now
        });
        showToast('Edited successfully');
      } else {
        await addExecutorToFirestore({
          name, version, platforms, link, status,
          imageData: selectedImageData,
          createdAt: now
        });
        showToast('Added successfully');
      }
      closeModal();
      await fetchExecutors();
    });

    closeModalBtn.addEventListener('click', closeModal);
    btnCancel.addEventListener('click', closeModal);

    [nameInput, versionInput, linkInput].forEach(el => {
      el.addEventListener('input', saveDraft);
    });
    platformsSelect.addEventListener('change', saveDraft);
    statusSelect.addEventListener('change', saveDraft);

    async function deleteExecutor(docId) {
      if (!confirm('Are you sure you want to delete?')) return;
      await deleteExecutorFromFirestore(docId);
      showToast('Deleted successfully');
      await fetchExecutors();
    }

    function checkLink(url) {
      fetch(url, { method: 'HEAD' })
        .then(response => {
          if (response.ok) showToast('Link OK');
          else showToast('Link unreachable');
        })
        .catch(() => showToast('Link unreachable'));
    }

    btnAdd.addEventListener('click', () => openModal('add'));
    filterPlatform.addEventListener('change', renderCards);

    document.addEventListener('DOMContentLoaded', async () => {
      PLATFORMS.forEach(p => collapseState[p] = false);
      await fetchExecutors();
    });
  </script>
</body>
</html>
